# å‰ç«¯æ„å»ºç§˜ç±

> ä½œè€…ï¼šåˆ˜å

## å‰è¨€

éšç€å‰ç«¯æ„æ¶å·¥å…·çš„ä¸æ–­å‘å±•ï¼Œæä¾›äº†å¾ˆå¤šæé«˜æˆ‘ä»¬çš„å¼€å‘ä½“éªŒå’Œå¼€å‘æ•ˆç‡çš„èƒ½åŠ›ï¼ŒåŒæ—¶æ„å»ºå·²ç»æˆä¸ºå‰ç«¯æŠ€æœ¯æ ˆä¸­å¸¸è§çš„æŠ€æœ¯ã€‚

webpack ä¹Ÿæ˜¯ä¼—å¤šæ„å»ºå·¥å…·ä¸­å´­éœ²å¤´è§’ä¸€å‘˜ï¼Œæ—©æœŸçš„ webpack é…ç½®å¤æ‚éš¾æ‡‚ï¼Œéšç€å…¶å‘å±•ï¼Œç›¸å…³é…ç½®ä¹Ÿä¸æ–­ç®€åŒ–ï¼Œæ€§èƒ½ä¹Ÿä¸æ–­æé«˜ï¼Œä½†æ˜¯å¯¹äºæ·±å…¥ä½¿ç”¨çš„å¼€å‘äººå‘˜ï¼Œé€šå¸¸å®ƒçš„é»˜è®¤é…ç½®å¹¶ä¸é€‚ç”¨äºä¸šåŠ¡å¼€å‘ï¼Œéœ€è¦é’ˆå¯¹è‡ªå·±ä¸šåŠ¡è°ƒæ•´é€‚é…ã€‚

ä½ å¯¹ webpack äº†è§£å¤šå°‘ï¼Ÿå¦‚ä½•é’ˆå¯¹ä¸šåŠ¡é›†æˆæœ€ä½³é…ç½®ï¼Ÿå¦‚ä½•ä¼˜åŒ–å¼€å‘ä½“éªŒï¼Ÿå¦‚ä½•å¼€è¶³é©¬åŠ›ï¼Œå®ç°æé€Ÿçš„ webpack çš„æ„å»ºæ€§èƒ½ ğŸš€ï¼Ÿåˆä¼šæœ‰å“ªäº›å‘ ğŸ’£ï¼Ÿæœ¬æ–‡å¸¦ä½ è§£ç­”è¿™äº›é—®é¢˜ ğŸ”­ã€‚

*æœ¬æ–‡æ¶‰åŠåˆ°çš„æ‰€æœ‰ä»£ç ç‰‡æ®µçš„å®Œæ•´ä»£ç è¯·å‚è€ƒ[a8kä»“åº“](https://github.com/hxfdarling/a8k)*

## ä¸€ã€webpack å…³é”®é…ç½®é¡¹

> å¯¹æ„å»ºæœ‰æ‰€äº†è§£çš„ï¼Œå¯ç›´æ¥ç•¥è¿‡æœ¬èŠ‚

æ­¤å¤„ä¸ä¼šæ·±å…¥ä»‹ç»ç›¸å…³é…ç½®ï¼Œæ›´å¤šçš„è¯¦ç»†è¯´æ˜ä¸é…ç½®å‚è§å®˜æ–¹æ–‡æ¡£ï¼Œç¨ä½œä»‹ç»å…³é”®é…ç½®é¡¹é“ºå«åé¢å†…å®¹ã€‚

### entry

webpack æŸ¥æ‰¾ä¾èµ–çš„å…¥å£æ–‡ä»¶é…ç½®ï¼Œå…¥å£æ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ªã€‚

**å•é¡µé¢åº”ç”¨å…¥å£é…ç½®** é€šå¸¸åšæ³•é…ç½®ï¼švendor.js ç¬¬ä¸‰æ–¹ä¾èµ–åº“ï¼Œpolyfill.js ç‰¹æ€§å¡«å……åº“ï¼Œindex.js å•é¡µé¢åº”ç”¨å…¥å£æ–‡ä»¶

```
// å¯¼å‡ºé…ç½®
module.exports = {
  entry: {
    vendor: './src/vendor.js',
    polyfill: './src/polyfill.js',
    index: './src/index.js',
  },
};
å¤åˆ¶ä»£ç 
```

**å¤šé¡µé¢åº”ç”¨å…¥å£é…ç½®** å’Œå•é¡µé¢åº”ç”¨ç±»ä¼¼ï¼Œä½†ä¸åŒé¡µé¢ä¼šä¸åŒæœ‰å…¥å£æ–‡ä»¶ï¼Œè¿™ç§æƒ…å†µé«˜æ•ˆçš„åšæ³•å°±ä¸æ˜¯ç›´æ¥å†™æ­»åœ¨ entry é‡Œé¢äº†ï¼Œè€Œæ˜¯é€šè¿‡ç”Ÿæˆ webpack.config æ—¶ï¼Œæ‰«ææŒ‡å®šç›®å½•ç¡®å®šæ¯ä¸ªé¡µé¢çš„å…¥å£æ–‡ä»¶ä»¥åŠæ‰€æœ‰çš„é¡µé¢ã€‚

ä¸‹é¢ä¸¾ä¸ªä¾‹å­

> å‡å®šä½ çš„é¡µé¢éƒ½æ”¾ç½®åœ¨ src/pages ç›®å½•ä¸‹é¢ï¼Œå¹¶ä¸”ä½ çš„æ¯ä¸ªé¡µé¢å•ç‹¬ä¸€ä¸ªç›®å½•ï¼Œå¹¶ä¸”å…¶ä¸­æœ‰ index.html å’Œ index.jsx

```
const path = require('path');
const fs = require('fs');
// å¤„ç†å…¬å…±entry
const commonEntry = ['./src/vendor.js', './src/polyfill.js'];
// é¡µé¢ç›®å½•
const PAGES_DIR = './src/pages/';
const entry = {};
// éå†é¡µé¢ç›®å½•
const getPages = () => {
  return fs.readdirSync(PAGES_DIR).filter(item => {
    let filepath = path.join(PAGES_DIR, item, 'index.js');
    if (!fs.existsSync(filepath)) {
      filepath = `${filepath}x`; // jsx
    }
    if (!fs.existsSync(filepath)) {
      return false;
    }
    return true;
  });
};
getPages(options).forEach(file => {
  const name = path.basename(file);
  // åŠ å…¥é¡µé¢éœ€è¦çš„å…¬å…±å…¥å£
  entry[name] = [...commonEntry, `${PAGES_DIR}/${file}/index`];
});
// å¯¼å‡ºé…ç½®
module.exports = {
  entry,
};
å¤åˆ¶ä»£ç 
```

**å…¥å£ boundle å¦‚ä½•æ’å…¥å¯¹åº”çš„ html ä¸­ï¼Ÿ**

æˆ‘ä»¬é€šå¸¸éœ€è¦è¿™ä¸ªæ’ä»¶`HtmlWebpackPlugin`è‡ªåŠ¨å¤„ç†ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```
const plugins = [];
if (mode === 'single') {
  // å•é¡µé¢åªéœ€è¦ä¸€æ¬¡HtmlWebpackPlugin
  plugins.push(
    new HtmlWebpackPlugin({
      minify: false,
      filename: 'index.html',
      template: './src/index.html',
    })
  );
}
if (mode === 'multi') {
  // å¤šé¡µé¢éå†ç›®å½•ï¼Œä½¿ç”¨ç›®å½•ä¸‹é¢çš„htmlæ–‡ä»¶
  // ä¸åŒé¡µé¢çš„é…ç½®ä¸åŒï¼Œæ¯ä¸ªé¡µé¢éƒ½å•ç‹¬é…ç½®ä¸€ä¸ªhtml
  // æ‰€æœ‰é¡µé¢çš„å…¬å…±éƒ¨åˆ†å¯ä»¥æŠ½ç¦»åï¼Œé€šè¿‡æ¨¡ç‰ˆå¼•æ“ç¼–è¯‘å¤„ç†
  // å…·ä½“çš„æ–¹å¼åé¢éƒ¨åˆ†loaderä¸­æåˆ°
  const files = getPages(options);
  files.forEach(file => {
    const name = path.basename(file);
    file = `${PAGES_DIR}/${file}/index.html`;
    // æ·»åŠ runtimeè„šæœ¬ï¼Œå’Œé¡µé¢å…¥å£è„šæœ¬
    const chunks = [`runtime~${name}`, name];
    plugins.push(
      new HtmlWebpackPlugin({
        minify: false,
        filename: `${name}.html`,
        template: file,
        chunks,
      })
    );
  });
}
// å¯¼å‡ºé…ç½®
module.exports = {
  plugins,
};
å¤åˆ¶ä»£ç 
```

### output

è¯¥é¡¹é…ç½®è¾“å‡ºçš„ bundle çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„é…ç½®å¦‚ä¸‹ï¼š

```
{
  output:{
   // nameæ˜¯ä½ é…ç½®çš„entryä¸­keyåç§°ï¼Œæˆ–è€…ä¼˜åŒ–åchunkçš„åç§°
   // hashæ˜¯è¡¨ç¤ºbundleæ–‡ä»¶åæ·»åŠ æ–‡ä»¶å†…å®¹hashå€¼ï¼Œä»¥ä¾¿äºå®ç°æµè§ˆå™¨æŒä¹…åŒ–ç¼“å­˜æ”¯æŒ
   filename: '[name].[hash].js',
   // åœ¨scriptæ ‡ç­¾ä¸Šæ·»åŠ crossOrigin,ä»¥ä¾¿äºæ”¯æŒè·¨åŸŸè„šæœ¬çš„é”™è¯¯å †æ ˆæ•è·
   crossOriginLoading:'anonymous',
   //é™æ€èµ„æºè·¯å¾„ï¼ŒæŒ‡çš„æ˜¯è¾“å‡ºåˆ°htmlä¸­çš„èµ„æºè·¯å¾„å‰ç¼€
   publicPath:'https://7.ur.cn/fudao/pc/',
   path: './dist/',//æ–‡ä»¶è¾“å‡ºè·¯å¾„
  }
}
å¤åˆ¶ä»£ç 
```

### resolve

è¯¥é¡¹é…ç½®ä¸»è¦ç”¨äºè§£ææ¨¡å—ä¾èµ–çš„è‡ªå®šä¹‰é¡¹, æ¯”è¾ƒå¸¸è§„çš„é…ç½®é¡¹å¦‚ä¸‹ï¼Œmodulesç”¨äºåŠ é€Ÿç»å¯¹è·¯å¾„æŸ¥æ‰¾æ•ˆç‡ï¼Œaliaså¯ä»¥ç”¨æˆ·è‡ªå®šä¹‰æ¨¡å—æŸ¥æ‰¾è·¯å¾„ã€‚

```
resolve: {
    modules: [
        path.resolve(__dirname, 'src'), 
        path.resolve(__dirname,'node_modules'),
    ],
    alias: {
      components: path.resolve(__dirname, '/src/components'),
    },
}
å¤åˆ¶ä»£ç 
```

**æ‰©å±•** å¦‚æœä½ ä½¿ç”¨äº†ç»å¯¹è·¯å¾„åï¼Œå¯èƒ½å°±å‘ç°vscodeæ™ºèƒ½ä»£ç å¯¼èˆªå°±å¤±æ•ˆäº†ï¼Œåˆ«æ…Œï¼è¯·åœ¨æƒ³ç›®å½•ä¸‹é¢é…ç½®`jsconfig.json`æ–‡ä»¶è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé…ç½®å’Œä¸Šé¢å¯¹åº”:

```
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "src/*": ["./src/*"],
      "components/*": ["./src/components/*"],
      "assets/*": ["./src/assets/*"],
      "pages/*": ["./src/pages/*"]
    }
  },
  "include": ["./src/**/*"]
}
å¤åˆ¶ä»£ç 
```

è¿™æ ·ï¼Œä½ å°±å¯ä»¥æ„‰å¿«çš„ä½¿ç”¨vscodeçš„æ™ºèƒ½ä»£ç æç¤ºå’Œå¯¼èˆªäº†ï¼

### module

è¯¥é¡¹ä¸»è¦é…ç½®å°±æ˜¯rulesäº†ï¼Œrulesä¸­é…ç½®å¯¹äºä¸åŒèµ„æºçš„å¤„ç†å™¨ï¼Œæ˜¯å…¶æ ¸å¿ƒä¹‹ä¸€ï¼Œè¿™é‡Œç®€å•æ·»åŠ ä¸€ä¸ªç¤ºä¾‹ä»£ç 

```
module: {
  // è¿™äº›åº“éƒ½æ˜¯ä¸ä¾èµ–å…¶å®ƒåº“çš„åº“ ä¸éœ€è¦è§£æä»–ä»¬å¯ä»¥åŠ å¿«ç¼–è¯‘é€Ÿåº¦
  // é€šå¸¸å¯ä»¥å°†é‚£äº›å¤§å‹çš„åº“ä¸”å·²ç»ç¼–è¯‘å¥½çš„åº“æ’é™¤ï¼Œå‡å°‘webpackå¯¹å…¶è§£æè€—æ—¶
  noParse: /node_modules\/(moment|chart\.js)/,
  rules: [
    {
      test: /\.jsx?$/,
      use: resolve('babel-loader'),
      // éœ€è¦è¢«è¿™ä¸ªloaderå¤„ç†çš„èµ„æº
      include: [
        path.resolve(projectDir, 'src'),
        path.resolve(projectDir, 'node_modules/@tencent'),
      ].filter(Boolean),
      // å¿½ç•¥å“ªäº›å‹ç¼©çš„æ–‡ä»¶
      exclude: [/(.|_)min\.js$/],
    }
  ]
å¤åˆ¶ä»£ç 
```

### optimization

è¯¥é¡¶é…é¡¹ä¸­æœ€é‡è¦æœ€å¸¸ç”¨çš„æ˜¯:`splitChunks`,`minimizer`

`minimizer` å¯ä»¥è‡ªå·±é…ç½®è¾“å‡ºçš„æ–‡ä»¶å‹ç¼©æ’ä»¶ï¼Œjså‹ç¼©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨webpacké›†æˆçš„uglifyjsï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Terserï¼ŒTerseræ”¯æŒes6ä»£ç çš„å‹ç¼©,åŒæ—¶æ”¯æŒå¤šè¿›ç¨‹å‹ç¼©ï¼›csså‹ç¼©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`optimize-css-assets-webpack-plugin`å‹ç¼©ï¼Œå®ƒä½¿ç”¨cssnanoä½œä¸ºå¤„ç†å¼•æ“ï¼Œå¸®åŠ©æˆ‘ä»¬å»é™¤é‡å¤æ ·å¼.

`splitChunks`æ˜¯webpack4.xæ¨å‡ºçš„é‡ç£…åŠŸèƒ½ï¼Œä¼˜åŒ–çš„å…¬å…±chunkæå–ç­–ç•¥ï¼Œæ›´é«˜æ•ˆçš„æå–å…¬å…±æ¨¡å—ï¼Œåœ¨åé¢æ€§èƒ½ä¼˜åŒ–ä¸­ä¼šè¯¦ç»†è¯´æ˜å…¶ä½¿ç”¨æ–¹æ³•ã€‚

### plugin

plugin å¯ä»¥ä»‹å…¥æ•´ä¸ªæ„å»ºè¿‡ç¨‹ä»»ä½•é˜¶æ®µã€‚ä¾‹å¦‚ï¼šæŠ¥å‘Šæ„å»ºè€—æ—¶ã€ä¿®æ”¹è¾“å‡ºä»£ç æ”¯æŒä¸»åŸŸé‡è¯•ã€æ·»åŠ æ„å»ºè¿›åº¦æŠ¥å‘Šã€ä»£ç å‹ç¼©ã€èµ„æºæ›¿æ¢ç­‰å¾ˆå¤šèƒ½åŠ›éƒ½åœ¨è¿™é‡Œå®ç°ã€‚

pluginä¸å±•å¼€è®¨è®ºï¼Œå› ä¸ºæ’ä»¶å¤ªå¤šäº†ã€‚å¯¹äºé¡¹ç›®éœ€è¦è‡ªå·±å®ç°æ’ä»¶çš„ï¼Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå½“ä½ ä½¿ç”¨æ’ä»¶å¯¹è¾“å‡ºç»“æœå¤„ç†æ—¶ï¼Œåº”å½“åœ¨æ–‡ä»¶è¾“å‡ºåˆ°ç£ç›˜ä¹‹å‰å¤„ç†ï¼Œæˆ‘ä»¬ä»¥å‰çš„æ„å»ºä¸­ä¸»åŸŸé‡è¯•æ’ä»¶å°±è¸©äº†è¿™ä¸ªåˆï¼Œå¯¼è‡´æœ€ç»ˆæ„å»ºçš„ä»£ç å‡ºç°é”™è¯¯ï¼ŒåŸå› æ˜¯è¯¥æ’ä»¶ç›´æ¥ä¿®æ”¹ç£ç›˜ä¸Šé¢çš„æ–‡ä»¶ï¼Œä¸¤æ¬¡æ„å»ºåŒæ—¶å¯åŠ¨ï¼Œç»“æŸæ—¶ä¸¤æ¬¡æ„å»ºçš„æ’ä»¶éƒ½ä¿®æ”¹äº†ç£ç›˜ä¸ŠåŒä¸€ä¸ªæ–‡ä»¶ï¼Œæœ€ç»ˆå¯¼è‡´bugï¼Œå¹¶ä¸”å¯¼è‡´æˆ‘ä»¬éœ€è¦å¼ºè¡Œæ¸…ç†å‘å¸ƒç¯å¢ƒä»£ç æ‰æ¢å¤æ­£å¸¸å‘å¸ƒã€‚

## äºŒã€å¼€å‘ä½“éªŒä¼˜åŒ–

èˆ’é€‚çš„å¼€å‘ä½“éªŒï¼Œæœ‰åŠ©äºæé«˜æˆ‘ä»¬çš„å¼€å‘æ•ˆç‡ï¼Œä¼˜åŒ–å¼€å‘ä½“éªŒä¹Ÿè‡³å…³é‡è¦

### ç»„ä»¶çƒ­åˆ·æ–°ã€CSSçƒ­åˆ·æ–°

è‡ªä»webpackæ¨å‡ºçƒ­åˆ·æ–°åï¼Œå‰ç«¯å¼€å‘è€…åœ¨å¼€ç¯å¢ƒä¸‹ä½“éªŒå¤§å¹…æé«˜ã€‚ æ²¡æœ‰çƒ­åˆ·æ–°èƒ½åŠ›ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸ªç»„ä»¶å



![img](https://user-gold-cdn.xitu.io/2019/3/19/169944d12d4e7f68?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



åŠ å…¥çƒ­æ„å»ºåï¼š



![img](https://user-gold-cdn.xitu.io/2019/3/19/169944d60ba647a3?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



ä¸»è¦çœ‹ä¸€ä¸‹æˆ‘ä»¬ä¸šåŠ¡åŸºäºReactæŠ€æœ¯æ ˆï¼Œå¦‚ä½•åœ¨æ„å»ºä¸­æ¥å…¥çƒ­åˆ·æ–°ã€‚

1. æ— è®ºä»€ä¹ˆæŠ€æœ¯æ ˆï¼Œéƒ½éœ€è¦åœ¨devæ¨¡å¼ä¸‹åŠ ä¸Š`webpack.HotModuleReplacementPlugin`æ’ä»¶

2. åœ¨æ‰€æœ‰entryä¸­æ’å…¥`require.resolve('../utils/webpackHotDevClient')`,`webpackHotDevClient`è¿™ä»½ä»£ç æ˜¯ç”±reactå®˜æ–¹çš„create-react-appæä¾›çš„

3. åœ¨`webpack-dev-server`æ¨¡å—çš„å¯åŠ¨å‚æ•°ä¸­æ·»åŠ `hot:true`

4. åœ¨ä½ éœ€è¦çƒ­åŠ è½½çš„jsæ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç (è¿™æ®µä»£ç åœ¨æ„å»ºç”Ÿäº§åŒ…ä¼šè‡ªåŠ¨åˆ é™¤):

   ```
   if (process.env.NODE_ENV==='development' && module.hot) {
       module.hot.accept()
   }
   
   å¤åˆ¶ä»£ç 
   ```

*æ³¨ï¼šä¹Ÿå¯ä»¥ä½¿ç”¨[react-hot-loader](https://github.com/gaearon/react-hot-loader)æ¥å®ç°ï¼Œå…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£*

### SSRçƒ­è°ƒè¯•

è¾…å¯¼çš„H5/PCé¡¹ç›®éƒ½æœ‰éƒ¨åˆ†é¡µé¢æ”¯æŒç›´å‡ºï¼Œä»¥å‰ç›´å‡ºè°ƒè¯•æ–¹å¼æ˜¯å¦‚ä¸‹æµç¨‹æ‰€ç¤ºï¼š



![img](https://user-gold-cdn.xitu.io/2019/3/19/169944dfb7c29ce1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



è¿™ç§è°ƒè¯•æµç¨‹å¤ªé•¿ï¼Œæ¯ä¸€æ¬¡ä¿®æ”¹éƒ½éœ€è¦é‡æ–°æ„å»ºé™æ€èµ„æºï¼Œå¹¶é‡å¯nodeæœåŠ¡ï¼Œéå¸¸è€—æ—¶ï¼Œå…¶æ¬¡ç›´å‡ºæ¨¡å¼ä¸‹ï¼Œéç›´å‡ºçš„é¡µé¢å°†æ— æ³•æ­£å¸¸è®¿é—®ï¼Œæ•´ä¸ªæµç¨‹æ— æ³•èµ°é€šã€‚

å› æ­¤, æå‡ºäº†æ–°çš„è§£å†³æ–¹æ¡ˆ, é‡‡ç”¨ `webpack watch+nodemon` ç»“åˆçš„æ¨¡å¼å®ç°å¯¹SSRçƒ­è°ƒè¯•çš„æ”¯æŒã€‚node æœåŠ¡éœ€è¦çš„html/jsé€šè¿‡webpackæ’ä»¶åŠ¨æ€è¾“å‡ºï¼Œå½“nodemonæ£€æµ‹åˆ°å˜åŒ–åå°†è‡ªåŠ¨é‡å¯ï¼Œhtmlæ–‡ä»¶ä¸­çš„é™æ€èµ„æºå…¨éƒ¨æ›¿æ¢ä¸ºdevæ¨¡å¼ä¸‹çš„èµ„æºï¼Œå¹¶ä¿æŒsocketè¿æ¥è‡ªåŠ¨æ›´æ–°é¡µé¢ã€‚

å®ç°çƒ­è°ƒè¯•åï¼Œè°ƒè¯•æµç¨‹å¤§å¹…ç¼©çŸ­ï¼Œå’Œæ™®é€šéç›´å‡ºæ¨¡å¼è°ƒè¯•ä½“éªŒä¿æŒä¸€è‡´ã€‚åœ¨`a8k`ä¸­é€šè¿‡`k dev -s`å‘½ä»¤å³å¯å¼€å¯ssrè°ƒè¯•æ¨¡å¼ã€‚ä¸‹é¢æ˜¯SSRçƒ­è°ƒè¯•çš„æµç¨‹å›¾ï¼š



![img](https://user-gold-cdn.xitu.io/2019/3/19/169944e581d698b2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



### styleè°ƒè¯•ä½“éªŒ

**é—®é¢˜ï¼š**

ç»™`style-loader` å¼€å¯sourceMapå, sourceMapæ˜¯å†…è”åœ¨styleæ–‡ä»¶ä¸­çš„ï¼Œéœ€è¦é€šè¿‡linkå¯¼å…¥ï¼Œè¿™ç§æ–¹å¼æ˜¯é€šè¿‡JavaScriptç”Ÿæˆblobåä¸¢ä¸ªlinkæ ‡ç­¾è§£æã€‚ä¹‹åæˆ‘ä»¬å¯ä»¥åœ¨devå·¥å…·ä¸­ç›´æ¥çœ‹åˆ°æ¯ä¸ªæ ·å¼æ‰€åœ¨çš„æºæ–‡ä»¶ä½ç½®ï¼Œæ–¹ä¾¿å¿«é€Ÿçš„è°ƒè¯•æ ·å¼ã€‚ä½†ä¹ŸåŒæ ·å¼•èµ·ä¸€ä¸ªé—®é¢˜FOUCï¼ˆé¡µé¢åŠ è½½åé—ªçƒï¼‰ï¼Œå¯å‚è§è¿™ä¸ª[ssue](https://github.com/webpack-contrib/style-loader/issues/107)

**è§£å†³æ–¹æ³•ï¼š**

æ·»åŠ `singleton: true`å‚æ•°å¯è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯sourceMapå°±ä¸èƒ½å®šä½åˆ°æºæ–‡ä»¶äº†ï¼Œè€Œæ˜¯åˆå¹¶åçš„æ–‡ä»¶ä¸­çš„ä½ç½®ï¼ŒäºŒè€…ä¸å¯å…¼å¾—ã€‚æ‰€ä»¥åœ¨`a8k`å·¥å…·ä¸­æä¾›äº†å¯é€‰é¡¹ï¼Œé»˜è®¤å¼€å¯`singleton:true`,é€šè¿‡`k dev -c`å¯å¼€å¯cssSourceMapæ˜ å°„

## ä¸‰ã€æ€§èƒ½ä¼˜åŒ–

### node_modulesç¼“å­˜

> è¾…å¯¼å¤§å¤šæ•°é¡¹ç›®node_modulesä¾èµ–æ•°é‡éƒ½éå¸¸æƒŠäººï¼Œè¾…å¯¼PCé¡¹ç›®å‰”é™¤æ„å»ºç›¸å…³ä¾èµ–åï¼Œä¾èµ–åŒ…éƒ½1883ä¸ªï¼Œä¾èµ–åŒ…çš„å®‰è£…è€—æ—¶ä¹Ÿå°±å¤§å¹…å¢åŠ ï¼Œå› æ­¤å‡å°‘ä¾èµ–åŒ…å®‰è£…è€—æ—¶,å¯¹æ„å»ºæ•´ä½“æå‡éå¸¸é‡è¦ï¼Œæ–¹æ³•é‚£å°±æ˜¯ç¼“å­˜ã€‚

**JBç³»ç»Ÿç¼–è¯‘** æ¯æ¬¡ç¼–è¯‘éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ç›®å½•ï¼Œè¿™å¯¼è‡´é¡¹ç›®ä¾èµ–çš„ä¼—å¤šnode_modulesæ— æ³•ç¼“å­˜ï¼Œæ¯æ¬¡ç¼–è¯‘é‡æ–°å®‰è£…è€—æ—¶éå¸¸é•¿ï¼Œé’ˆå¯¹JBçš„ç¼–è¯‘ï¼Œæˆ‘å¼€å‘äº†@tencent/im-buildæ¨¡å—è‡ªåŠ¨ç¼“å­˜é¡¹ç›®ä¾èµ–çš„node_modulesï¼Œå¤§å¹…æå‡äº†ç¼–è¯‘æ€§èƒ½ã€‚

**OCIç¼–è¯‘ç³»ç»Ÿ** OCIä¸­ä¸éœ€è¦é¢å¤–çš„æ’ä»¶æ”¯æŒï¼Œè¯¥ç³»ç»Ÿæœ¬èº«å·²ç»å¯ä»¥é€šè¿‡é…ç½®å®ç°éƒ¨åˆ†ç›®å½•ç¼“å­˜ï¼ŒäºŒæ¬¡åˆ©ç”¨çš„èƒ½åŠ›ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

1. åœ¨é¡¹ç›®æ ¹ç›®å½•æ·»åŠ `.orange-cache.cache`æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä½ éœ€è¦ç¼“å­˜çš„ç›®å½•

   ```
   /node_modules
   /fudao_qq_com_pc_imt
   
   å¤åˆ¶ä»£ç 
   ```

2. ä¿®æ”¹`.orange-ci.yml`é…ç½®ï¼Œæ·»åŠ ç¼“å­˜é…ç½®æ–‡ä»¶è·¯å¾„

   ```
     push:
       - cacheFrom: .orange-ci.cache
       #å…¶å®ƒé…ç½®çœç•¥
   
   å¤åˆ¶ä»£ç 
   ```

#### ä¼˜åŒ–æ•ˆæœ

**ä¼˜åŒ–å‰**



![img](https://user-gold-cdn.xitu.io/2019/3/19/169944fe0fda49b6?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



**ä¼˜åŒ–å**



![img](https://user-gold-cdn.xitu.io/2019/3/19/1699450034025031?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



### æ„å»ºä¸­é—´ç»“æœç¼“å­˜

ä¸­é—´ç»“æœç¼“å­˜ä¼˜åŒ–åŒæ ·èƒ½å¤§å¹…æå‡æ„å»ºæ€§èƒ½ï¼Œå¯¹æ¨¡å—çš„ç¼–è¯‘æœ¬èº«å°±æ˜¯CPUå¯†é›†å‹ä»»åŠ¡ã€‚é€šå¸¸æ¥è¯´æ¯æ¬¡æ„å»ºå¹¶éæ‰€æœ‰æ¨¡å—éƒ½éœ€è¦è¢«é‡æ–°å¤„ç†ï¼Œå¯ä»¥åªè€ƒè™‘å¤„ç†é‚£äº›æ–‡ä»¶å†…å®¹æœ‰å˜åŒ–çš„æ¨¡å—ï¼Œé‚£ä¹ˆæ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–çš„æ¨¡å—å°±å¯ä»¥ä»ç¼“å­˜ä¸­è·å–ï¼Œé€šå¸¸é€šè¿‡æ–‡ä»¶å†…å®¹hashå€¼ä½œä¸ºç¼“å­˜æ–‡ä»¶çš„åç§°ï¼Œè¿™å°±æ˜¯â€œçƒ­æ„å»ºâ€ã€‚

åœ¨webpackä¸­ï¼Œèƒ½å¤Ÿè¢«ç¼“å­˜çš„å†…å®¹æœ‰ï¼šloaderå¤„ç†ç»“æœã€pluginå¤„ç†ç»“æœã€è¾“å‡ºæ–‡ä»¶ç»“æœã€‚ä¸‹é¢è¯¦ç»†è¯´æ˜ä¸åŒèµ„æºä¸åŒé˜¶æ®µçš„ç¼“å­˜æ–¹å¼ã€‚

#### 1. babel-loaderç¼“å­˜,é€šè¿‡cacheDirectoryå¼€å¯ç¼“å­˜

```
test: /\.jsx?$/,
use: [
  {
    loader: resolve('babel-loader'),
    options: {
      babelrc: false,
      // cacheDirectory ç¼“å­˜babelç¼–è¯‘ç»“æœåŠ å¿«é‡æ–°ç¼–è¯‘é€Ÿåº¦
      cacheDirectory: path.resolve(options.cache, 'babel-loader'),
      presets: [[require('babel-preset-imt'), { isSSR }]],
    },
  },
],

å¤åˆ¶ä»£ç 
```

#### 2. eslint-loaderç¼“å­˜,é€šè¿‡cacheé€‰é¡¹æŒ‡å®šç¼“å­˜è·¯å¾„

```
test: /\.(js|mjs|jsx)$/,
enforce: 'pre',
use: [
    {
      options: {
        cache: path.resolve(options.cache, 'eslint-loader'),
      },
      loader: require.resolve('eslint-loader'),
    },
],

å¤åˆ¶ä»£ç 
```

*eslint-loaderé€šå¸¸åªéœ€è¦åœ¨å¼€å‘æ¨¡å¼ä¸‹å¼€å¯ï¼Œæ–¹ä¾¿åŠæ—¶çš„æé†’å¼€å‘è€…ï¼Œå­˜åœ¨eslinté”™è¯¯ï¼ŒåŠæ—¶ä¿®å¤*

#### 3. css/scssç¼“å­˜

css-loader/sass-loader/postcss-loaderæœ¬èº«å¹¶æ²¡æœ‰æä¾›ç¼“å­˜æœºåˆ¶ï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°cache-loaderè¾…åŠ©æˆ‘ä»¬å®ç°å¯¹css/scssçš„æ„å»ºç»“æœç¼“å­˜ï¼Œå…·ä½“ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```
{
  loader: resolve('cache-loader'),
  options: { cacheDirectory: path.join(cache, 'cache-loader-css') },
},
{
  loader: resolve('css-loader'),
  options: {
    importLoaders: 2,
    sourceMap,
  },
},
...ç”±äºç¯‡å¹…åŸå› ï¼Œè¿™é‡Œä¸å±•ç¤ºå…¶å®ƒæ›´å¤šloader

å¤åˆ¶ä»£ç 
```

*åªéœ€è¦å°†è¯¥loaderæ·»åŠ åˆ°è¿™ä¸ªloaderçš„æœ€å¤´éƒ¨å³å¯ï¼Œè¯¥loaderä¸ä»…å¯ä»¥å¯¹äºcssç¼“å­˜*

#### 4. è¾“å‡ºä»£ç å‹ç¼©ç¼“å­˜ï¼ŒJSå‹ç¼©å¼•æ“å¤šè¿›ç¨‹å¤„ç†

JSä»£ç å‹ç¼©æˆ‘ä»¬é‡‡ç”¨äº†`TerserPlugin`æ’ä»¶ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š

```
{
    // è®¾ç½®ç¼“å­˜ç›®å½•
    cache: path.resolve(cache, 'terser-webpack-plugin'),
    parallel: true,// å¼€å¯å¤šè¿›ç¨‹å‹ç¼©
    sourceMap,
    terserOptions: {
      compress: {
        // åˆ é™¤æ‰€æœ‰çš„ `console` è¯­å¥
        drop_console: true,
      },
    },
}

å¤åˆ¶ä»£ç 
```

#### 5. CIç³»ç»Ÿå›ºå®šç¼“å­˜ç›®å½•

ä¸Šé¢åœ¨ä¸åŒçš„pluginå’Œloaderä¸Šé¢é…ç½®äº†cacheç›®å½•ï¼Œå¯¹äºCIç³»ç»Ÿæ¥è¯´ä½ éœ€è¦å°†cacheç›®å½•è·¯å¾„å›ºå®šï¼Œä»¥ä¾¿äºé‡å¤ä½¿ç”¨ç¼“å­˜å†…å®¹ï¼Œä½¿ç”¨æ–¹å¼ï¼šJBå°±é…ç½®`/tmp/xxx`ç›®å½•,OCIç³»ç»Ÿå¯é…ç½®åœ¨é¡¹ç›®ç›®å½•ã€‚

*âš ï¸æ³¨æ„ï¼šç”±äºä½¿ç”¨äº†ç¼“å­˜ï¼Œå½“ä½ ä¿®æ”¹ä½ çš„ç¼–è¯‘é…ç½®åï¼Œéœ€è¦ç«‹å³æ¸…ç†ç¼“å­˜ç»“æœï¼Œæœ€å¥½çš„åšæ³•æ˜¯åœ¨æ„å»ºå·¥å…·ä¸­è‡ªåŠ¨æ£€æµ‹ç›¸å…³é…ç½®æ˜¯å¦æœ‰å˜åŒ–ï¼Œè‡ªåŠ¨æ¸…ç†ç¼“å­˜*

### å…¶å®ƒä¼˜åŒ–æ‰‹æ®µ

#### 1. æŒ‡å®šç»å¯¹è·¯å¾„æ¨¡å—æŸ¥æ‰¾è·¯å¾„ï¼ŒåŠ é€Ÿæ¨¡å—æŸ¥æ‰¾

```
resolve: {
  //åŠ å¿«æœç´¢é€Ÿåº¦
  modules: [
    'node_modules', 
    path.resolve(projectDir, 'src'), 
    path.resolve(projectDir, 'node_modules')
  ],
},

å¤åˆ¶ä»£ç 
```

#### 2. è¿‡æ»¤ä¸éœ€è¦åšä»»ä½•å¤„ç†çš„åº“

```
module: {
  // è¿™äº›åº“éƒ½æ˜¯ä¸ä¾èµ–å…¶å®ƒåº“çš„åº“ ä¸éœ€è¦è§£æä»–ä»¬å¯ä»¥åŠ å¿«ç¼–è¯‘é€Ÿåº¦
  noParse: /node_modules\/(moment|chart\.js)/,
}

å¤åˆ¶ä»£ç 
```

#### 3. ç¼©å°babelå¤„ç†èŒƒå›´,é¿å…å¤„ç†å·²ç»å‹ç¼©çš„ä»£ç 

```
// æŒ‡å¤„ç†æŒ‡å®šç›®å½•çš„æ–‡ä»¶
include: [
    path.resolve(projectDir, 'src'),
    path.resolve(projectDir, 'node_modules/@tencent'),
].filter(Boolean),
// å¿½ç•¥å“ªäº›å‹ç¼©çš„æ–‡ä»¶
exclude: [/(.|_)min\.js$/],

å¤åˆ¶ä»£ç 
```

#### 4. lodashåº“æŒ‰éœ€å€’å…¥ä¼˜åŒ–ï¼Œå‡å°‘æ— ç”¨ä»£ç 

æˆ‘ä»¬åœ¨ä½¿ç”¨lodashåº“æ˜¯ï¼Œé€šå¸¸åªä¼šç”¨åˆ°å…¶ä¸­éå¸¸å°‘çš„functionï¼Œä½†æ˜¯åƒä¸‹é¢è¿™æ®µä»£ç ï¼Œå°†ä¼šå¯¼è‡´lodashå…¨éƒ¨è¢«æ‰“å…¥æœ€ç»ˆçš„bundleä¸­ã€‚

```
import _ from 'lodash'
_.difference(1, 2)

å¤åˆ¶ä»£ç 
```

è¿™ç§æƒ…å†µå¹¸å¥½æœ‰æ’ä»¶å¯ä»¥å¸®æˆ‘ä»¬ä¼˜åŒ–ï¼Œé€šè¿‡lodashPluginå³å¯è‡ªåŠ¨å¤„ç†lodashçš„æŒ‰éœ€å¼•ç”¨

ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```
const LodashPlugin = require('lodash-webpack-plugin');
plugins:[
    // æ”¯æŒlodashåŒ… æŒ‰éœ€å¼•ç”¨
    new LodashPlugin(),
]

å¤åˆ¶ä»£ç 
```

åŠ å…¥è¿™ä¸ªpluginåï¼Œä¸Šé¢çš„ä»£ç è‡ªåŠ¨å¤„ç†ä¸ºå¦‚ä¸‹ä»£ç ï¼š

```
import difference from 'lodash/difference';
difference([1, 2], [1, 3]);

å¤åˆ¶ä»£ç 
```

*æ³¨æ„ï¼šå¯¼å…¥ä»£ç æ–¹å¼å¿…é¡»ä½¿ç”¨importï¼Œä¸èƒ½ä½¿ç”¨require*

#### 5. é’ˆå¯¹æœåŠ¡ç«¯æ¸²æŸ“ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‰”é™¤node_modulesï¼Œä»è€Œå¤§å¹…å‡å°‘æœåŠ¡ç«¯ä»£ç ç”Ÿæˆè€—æ—¶

é€šè¿‡`webpack-node-externals`æ’ä»¶å®ç°è¿™ä¸€ç‚¹ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```
const nodeExternals = require('webpack-node-externals');
module.export={
// çœç•¥å…¶å®ƒé…ç½®
 externals: [
  nodeExternals({
    // æ³¨æ„å¦‚æœå­˜åœ¨srcä¸‹é¢å…¶ä»–ç›®å½•çš„ç»å¯¹å¼•ç”¨ï¼Œéƒ½éœ€è¦æ·»åŠ åˆ°è¿™é‡Œ
    whitelist: [
    /^components/, /^assets/, /^pages/, /^@tencent/, /\.(scss|css)$/
    ],
  }),
 ],
// çœç•¥å…¶å®ƒé…ç½®
}

å¤åˆ¶ä»£ç 
```

#### 6. webpack4.xçš„é¼åŠ›ä¹‹ä½œä¹‹splitChunks

åœ¨webpack4ä¹‹å‰ï¼Œæˆ‘ä»¬å¤„ç†å…¬å…±æ¨¡å—çš„æ–¹å¼éƒ½æ˜¯ä½¿ç”¨`CommonsChunkPlugin`ï¼Œç„¶åè¯¥æ’ä»¶çš„è®©å¼€å‘è¿™é…ç½®ç¹çï¼Œå¹¶ä¸”å…¬å…±ä»£ç çš„æŠ½ç¦»ï¼Œä¸å¤Ÿå½»åº•å’Œç»†è‡´ï¼Œå› æ­¤æ–°çš„`splitChunks`æ”¹è¿›äº†è¿™äº›èƒ½åŠ›ã€‚ä½¿ç”¨çš„æ­£ç¡®å§¿åŠ¿å¦‚ä¸‹ï¼š

```
splitChunks: {
      chunks: 'all',
      minSize: 10000, // æé«˜ç¼“å­˜åˆ©ç”¨ç‡ï¼Œè¿™éœ€è¦åœ¨http2/spdy
      maxSize: 0,//æ²¡æœ‰é™åˆ¶
      minChunks: 3,// å…±äº«æœ€å°‘çš„chunkæ•°ï¼Œä½¿ç”¨æ¬¡æ•°è¶…è¿‡è¿™ä¸ªå€¼æ‰ä¼šè¢«æå–
      maxAsyncRequests: 5,//æœ€å¤šçš„å¼‚æ­¥chunkæ•°
      maxInitialRequests: 5,// æœ€å¤šçš„åŒæ­¥chunksæ•°
      automaticNameDelimiter: '~',// å¤šé¡µé¢å…±ç”¨chunkå‘½ååˆ†éš”ç¬¦
      name: true,
      cacheGroups: {// å£°æ˜çš„å…¬å…±chunk
        vendor: {
         // è¿‡æ»¤éœ€è¦æ‰“å…¥çš„æ¨¡å—
          test: module => {
            if (module.resource) {
              const include = [/[\\/]node_modules[\\/]/].every(reg => {
                return reg.test(module.resource);
              });
              const exclude = [/[\\/]node_modules[\\/](react|redux|antd)/].some(reg => {
                return reg.test(module.resource);
              });
              return include && !exclude;
            }
            return false;
          },
          name: 'vendor',
          priority: 50,// ç¡®å®šæ¨¡å—æ‰“å…¥çš„ä¼˜å…ˆçº§
          reuseExistingChunk: true,// ä½¿ç”¨å¤ç”¨å·²ç»å­˜åœ¨çš„æ¨¡å—
        },
        react: {
          test({ resource }) {
            return /[\\/]node_modules[\\/](react|redux)/.test(resource);
          },
          name: 'react',
          priority: 20,
          reuseExistingChunk: true,
        },
        antd: {
          test: /[\\/]node_modules[\\/]antd/,
          name: 'antd',
          priority: 15,
          reuseExistingChunk: true,
        },
      },
    },

å¤åˆ¶ä»£ç 
```

ç®€è¦è§£é‡Šä¸Šé¢è¿™æ®µé…ç½®

1. å°†node_moduleså…±ç”¨éƒ¨åˆ†æ‰“å…¥vendor.js bundleä¸­ï¼›
2. å°†reactå…¨å®¶æ¡¶æ‰“å…¥react.js bundleä¸­ï¼›
3. å¦‚æœé¡¹ç›®ä¾èµ–äº†antdï¼Œé‚£ä¹ˆå°†antdæ‰“å…¥å•ç‹¬çš„bundleä¸­ï¼›
4. æœ€åå‰©ä¸‹çš„ä¸šåŠ¡æ¨¡å—è¶…è¿‡3æ¬¡å¼•ç”¨çš„å…¬å…±æ¨¡å—ï¼Œå°†è‡ªåŠ¨æå–å…¬å…±å—

### ä¼˜åŒ–æ•ˆæœ

åšäº†è¿™ä¹ˆå¤šä¼˜åŒ–ï¼Œä¸‹é¢æ˜¯åŸºäºæ¨¡å—è¶…è¿‡2.5kçš„è¾…å¯¼h5é¡¹ç›®ï¼Œæ„å»ºè€—æ—¶å¯¹æ¯”ï¼Œæ„Ÿå—ä¸€ä¸‹æ•ˆæœ

ä¼˜åŒ–å‰ï¼šçƒ­æ„å»ºéœ€è¦40s



![img](https://user-gold-cdn.xitu.io/2019/3/19/1699451530f0b7b0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



ä¼˜åŒ–åï¼šåªéœ€è¦20s



![img](https://user-gold-cdn.xitu.io/2019/3/19/169945179fbe08dc?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



## å››ã€æ”¶æ•›é…ç½®é›†æˆæœ€ä½³å®è·µ

æ„å»ºçš„é…ç½®å’Œä¼˜åŒ–çš„å·¥ä½œå¹¶ä¸å°ï¼Œå°†æœ€ä½³å®è·µæ”¶æ•›å’Œé›†æˆä¸ºç‹¬ç«‹çš„æ¨¡å—ï¼Œåœ¨ä¸åŒé¡¹ç›®ä¸­å¤ç”¨ï¼Œå¯ä»¥å¤§å¹…å‡å°‘æ„å»ºç»´æŠ¤å·¥ä½œï¼Œä»¥åŠåç»­å‡çº§ä¼˜åŒ–å·¥ä½œéš¾åº¦ã€‚

IMWebå›¢é˜Ÿçš„é¡¹ç›®ç›®å‰ä¹Ÿç‹¬ç«‹ç»´æŠ¤ä¸€å¥—åŸºäºReactæŠ€æœ¯æ ˆçš„æ„å»ºæœ€ä½³å®è·µå·¥å…·`a8k`ï¼Œåœ¨æ‰€æœ‰çš„é¡¹ç›®ä¸­ä¸ä¼šåœ¨çœ‹åˆ°å¤æ‚å¤šæ ·çš„webpacké…ç½®ï¼Œä»¥åŠå„ç§èŠ±æ ·çš„å‰ç½®ã€åç½®è„šæœ¬ã€‚å„é¡¹ç›®ä»…éœ€è¦ç®€å•çš„å…³é”®é…ç½®å³å¯å¿«é€Ÿæ¥å…¥è¯¥æ„å»ºå·¥å…·ï¼Œäº«å—å…¶å¸¦æ¥çš„å¼€å‘ä½“éªŒæå‡ï¼Œå’Œæ„å»ºæ€§èƒ½æå‡ã€‚

## äº”ã€å…¶ä»–ç»éªŒ

### å…³äºnode-sass

ç”¨è¿‡node-sassçš„ç«¥é‹åº”è¯¥é‡åˆ°è¿‡ï¼Œå®‰è£…node-sassé‡åˆ°å„ç§ç¼–è¯‘é”™è¯¯ã€äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½é”™è¯¯ã€ç”šè‡³æ–‡ä»¶å†™å…¥æƒé™é”™è¯¯ç­‰ç­‰ğŸ˜Ÿã€‚ä¹Ÿæœ‰å„ç§éªšæ“ä½œè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†ç»ˆå½’ä¸èƒ½ä¸€åŠ³æ°¸é€¸ã€‚

äºæ˜¯å°±å‡ºç°æƒ³é€šè¿‡postcssæ’ä»¶å»å…¼å®¹sassè¯­æ³•ï¼Œè™½ç„¶é€šè¿‡æ’ä»¶èƒ½å¤Ÿå…¼å®¹éƒ¨åˆ†è¯­æ³•ï¼Œä½†æ˜¯æƒ³è¦åœ¨å·²ç»æœ‰ä¸€å®šé‡çš„ä¸šåŠ¡ä»£ç ä¸­ï¼Œæ›¿æ¢node-sassçš„é£é™©æ˜¯éå¸¸é«˜çš„ï¼Œæœ¬äººäº²è‡ªæµ‹è¯•å„ç§å‘ğŸ’£

å½“ç„¶ä¹Ÿæœ‰å…¶ä»–é€”å¾„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸ä»…è®©ä½ ä½¿ç”¨å®Œæ•´çš„sassè¯­æ³•ï¼ŒåŒæ—¶ä¹Ÿå…å»å„ç§å®‰è£…node-sassçš„é—®é¢˜ï¼Œå®˜æ–¹çš„sass-loaderå…¶å®å·²ç»æä¾›äº†dart-sassè§£ææ¨¡å—çš„æ”¯æŒå…·ä½“å‚è§[æ–‡æ¡£](https://github.com/webpack-contrib/sass-loader#examples)ï¼Œå¯èƒ½æœ‰äººæ‹…å¿ƒdart-sassçš„jsæ¨¡å—æ€§èƒ½ä¸é«˜ï¼Œæœ¬äººäº²æµ‹åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­2000+çš„æ¨¡å—ä¸­ï¼Œdart-sassçš„ç¼–è¯‘æ€§èƒ½å¹¶æ²¡æœ‰æ˜æ˜¾ä¸‹é™çš„æ„Ÿè§‰ï¼ŒåŒæ—¶æˆ‘ä»¬ä½¿ç”¨ä½¿ç”¨äº†ç¼“å­˜èƒ½åŠ›ï¼Œé€šå¸¸åªå˜å¼‚å“ªäº›å˜åŒ–çš„èµ„æºã€‚

å…·ä½“çš„é…ç½®å…¥ä¸‹:

```
{
  loader: resolve('sass-loader'),
  options: {
    // å®‰è£…dart-sassæ¨¡å—ï¼šnpm i -D sass
    implementation: require('sass'),
    includePaths: [
      // æ”¯æŒç»å¯¹è·¯å¾„æŸ¥æ‰¾
      path.resolve(projectDir, 'src'),
    ],
    sourceMap,
  },
},

å¤åˆ¶ä»£ç 
```

node-sass å˜é‡ä½¿ç”¨é—®é¢˜ æˆ‘åœ¨H5ä¸­å‘ç°å¾ˆå¤šè¿™ç§è¯­æ³•çš„ä»£ç ï¼Œä½†æ˜¯å®é™…ä¸Šæ²¡æœ‰ç”Ÿæ•ˆï¼Œæ„å»ºåï¼Œå¹¶æ²¡æœ‰æ›¿æ¢ä¸ºå˜é‡çš„å€¼ã€‚



![img](https://user-gold-cdn.xitu.io/2019/3/19/16994521005732fa?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



ç¼–è¯‘åï¼š



![img](https://user-gold-cdn.xitu.io/2019/3/19/169945243e47e1ea?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š



![img](https://user-gold-cdn.xitu.io/2019/3/19/169945261c49daf2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



### å…³äº postcss

ä¸ªäººè§‰å¾—postcssæ˜¯cssé¢„å¤„ç†å™¨çš„æœªæ¥ï¼Œç°åœ¨çš„postcsså¯¹äºcsså°±åƒbabelå¯¹äºJavaScriptã€‚postcssé€šè¿‡æ’ä»¶æ”¯æŒæœªæ¥çš„cssç‰¹æ€§ï¼Œäºæ­¤åŒæ—¶ä½ è¿˜å¯ä»¥è‡ªå®šä¹‰æ’ä»¶å®ç°æƒ³è¦çš„ç‰¹æ€§ã€‚ä½†å…¶ä»–çš„lessã€sassè¿™ç§é¢„å¤„ç†å™¨ï¼Œå°±éš¾ä»¥ä»‹å…¥å®ƒçš„å¤„ç†è¿‡ç¨‹ï¼Œåªèƒ½æŒ‰ç…§å®ƒæ—¢å®šçš„è§„åˆ™å¤„ç†ã€‚å› æ­¤å¯¹äºå…¨æ–°çš„é¡¹ç›®å»ºè®®ç›´æ¥ä½¿ç”¨`postcss+postcss-preset-env` ä½¿ç”¨æœ€æ–°çš„cssè¯­æ³•ç‰¹æ€§ï¼ŒåŒæ—¶ä»¥ä¾¿äºåœ¨æœªæ¥æµè§ˆå™¨å…¨é¢æ”¯æŒç›¸å…³ç‰¹æ€§åï¼Œå¿«é€Ÿæ¥å…¥æ”¯æŒã€‚

ğŸ’£å¦‚æœä½ ä½¿ç”¨äº†`css-loader`çš„importèƒ½åŠ›ï¼ŒåŒæ—¶æœ‰ä½¿ç”¨äº†`post-css-import`æ’ä»¶çš„importèƒ½åŠ›ï¼Œä¸¤ä¸ªæ’ä»¶ä¼šå­˜åœ¨å†²çªï¼Œä¸å»ºè®®åŒæ—¶ä½¿ç”¨ï¼

å¦‚æœä½¿ç”¨äº†`postcss-custom-properties`,éœ€è¦æ³¨æ„åœ¨8.xç‰ˆæœ¬ä¸­å­˜åœ¨ä¸€ä¸ªbug,æ— æ³•è§£æå¦‚ä¸‹è¯­æ³•:

```
:root{
  --green: var(--customGreen, #08cb6a);
   // 8.xæ— æ³•æ­£ç¡®å¤„ç†è¯¥è¯­æ³•
  --primary: var(--customPrimary, var(--green));
}
.test {
  background: color(var(--primary) shade(5%));
  // ä¸Šé¢é¢è¿™å¥å°†ä¼šè¢«è½¬æ¢ä¸ºå¦‚ä¸‹ä»£ç ï¼Œæœ€ç»ˆå¯¼è‡´æµè§ˆå™¨æ— æ³•è§£æè¯¥è¯­æ³•
  background: var(--green);
  background: var(--primary);
  // æˆ‘ä»¬æœŸæœ›è½¬æ¢ä¸º
  background: #08cb6a;
}

å¤åˆ¶ä»£ç 
```

è§£å†³æ–¹æ³•ï¼šç¦ç”¨ postcss-preset-env ä¸­çš„custom-properties,å®‰è£…6.xç‰ˆæœ¬çš„custom-propertiesï¼Œå•ç‹¬æ·»åŠ è¯¥æ’ä»¶ã€‚

### å…³äºç¼“å­˜

å¦‚æœåœ¨å¼€å‘æ¨¡å¼ä¸‹é¢å¯ç”¨äº†`eslint-loader`å¯¹`jsx?`æ–‡ä»¶æ ¡éªŒï¼Œå¹¶ä¸”å¯åŠ¨äº†å…¶ç¼“å­˜èƒ½åŠ›ï¼Œå½“ä¿®æ”¹eslintæ ¡éªŒè§„åˆ™ï¼Œä½ éœ€è¦æ¸…ç†ç¼“å­˜æ–‡ä»¶å¹¶ä¸”é‡æ–°å¯åŠ¨æ„å»ºï¼Œå¦åˆ™è§„åˆ™ä¿®æ”¹ä¸ä¼šç”Ÿæ•ˆï¼å¦‚æœä½¿ç”¨`a8k`å·¥å…·æ„å»ºï¼Œå¯ä»¥ä½¿ç”¨`k clean`å‘½ä»¤è‡ªåŠ¨å¤„ç†å¤„ç†ã€‚

### ä¸»åŸŸé‡è¯•

ç¯‡å¹…å¤ªé•¿ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ç›¸å…³æºä»£ç [webpack-retry-load-plugin](https://github.com/hxfdarling/webpack-retry-load-plugin), åç»­è¾“å…¥ç›¸å…³æ–‡ç« ä»‹ç»å¦‚ä½•å®ç°CSS/JSåŒæ­¥å¼‚æ­¥ä»£ç é‡è¯•ã€‚